<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gestor de Clientes y Facturación</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  :root {
    --azul: #0b3c5d;
    --azul-claro: #1d6fa5;
    --verde: #1e9c4b;
    --gris: #f4f6f8;
  }

  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: var(--gris);
  }

  header {
    background: var(--azul);
    color: white;
    padding: 15px;
    text-align: center;
  }

  nav {
    background: var(--azul-claro);
    display: flex;
    flex-wrap: wrap;
  }

  nav button {
    flex: 1;
    padding: 12px;
    border: none;
    background: none;
    color: white;
    cursor: pointer;
  }

  nav button:hover {
    background: var(--azul);
  }

  section {
    display: none;
    padding: 15px;
  }

  section.active {
    display: block;
  }

  input, select, button {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
  }

  button {
    background: var(--azul);
    color: white;
    border: none;
  }

  button.danger {
    background: #c0392b;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    margin-top: 10px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
  }

  th {
    background: var(--azul);
    color: white;
  }

  @media (max-width: 768px) {
    nav {
      flex-direction: column;
    }
  }

  @media print {
    nav, button {
      display: none !important;
    }
  }
</style>
</head>

<body>

<header>
  <h1>Gestor de Clientes</h1>
</header>

<!-- LOGIN -->
<section id="login" class="active">
  <h2>Iniciar sesión</h2>
  <input type="text" id="loginUsuario" placeholder="Usuario">
  <input type="password" id="loginPassword" placeholder="Contraseña">
  <button onclick="login()">Entrar</button>
</section>

<!-- MENU -->
<nav id="menu" style="display:none">
  <button onclick="mostrar('clientes')">Clientes</button>
  <button onclick="mostrar('facturas')">Facturas</button>
  <button onclick="mostrar('reportes')">Reportes</button>
  <button onclick="mostrar('usuarios')">Usuarios</button>
  <button onclick="logout()">Salir</button>
</nav>

<!-- CLIENTES -->
<section id="clientes">
  <h2>Clientes</h2>
  <input id="numeroCliente" placeholder="Número de cliente">
  <input id="nombreCliente" placeholder="Nombre del cliente">
  <button onclick="guardarCliente()">Guardar cliente</button>
  <ul id="listaClientes"></ul>
</section>

<!-- FACTURAS -->
<section id="facturas">
  <h2>Facturas</h2>
  <select id="facturaCliente"></select>
  <input id="numeroFactura" placeholder="Número de factura">
  <input id="montoFactura" type="number" placeholder="Monto MXN">
  <input id="fechaFactura" type="date">
  <button onclick="guardarFactura()">Guardar factura</button>
</section>

<!-- REPORTES -->
<section id="reportes">
  <h2>Reportes</h2>

  <select id="tipoReporte">
    <option value="">Selecciona tipo</option>
    <option value="cliente">Por cliente</option>
    <option value="global">Global</option>
  </select>

  <select id="reporteCliente"></select>

  <button onclick="generarReporte()">Ver reporte</button>

  <div id="resultadoReporte"></div>
</section>

<!-- USUARIOS -->
<section id="usuarios">
  <h2>Usuarios (Administrador)</h2>

  <input id="nuevoNombre" placeholder="Nombre de usuario">
  <input id="nuevoPass" placeholder="Contraseña">
  <select id="nuevoRol">
    <option value="usuario">Usuario</option>
    <option value="admin">Administrador</option>
  </select>

  <button onclick="guardarUsuario()">Guardar usuario</button>
  <ul id="listaUsuarios"></ul>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD7fjnrJoDGf1LemftyATTiHKCHF_nG2vw",
    authDomain: "gestor-clientes-f96ad.firebaseapp.com",
    projectId: "gestor-clientes-f96ad",
    storageBucket: "gestor-clientes-f96ad.firebasestorage.app",
    messagingSenderId: "311331329644",
    appId: "1:311331329644:web:3f73825fd6775842ff2a49"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let usuarioActual = null;

  window.mostrar = (id) => {
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  };

  window.logout = () => location.reload();

  window.login = async function () {
    const u = loginUsuario.value;
    const p = loginPassword.value;

    const q = query(
      collection(db, "usuarios"),
      where("nombre", "==", u),
      where("password", "==", p)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      alert("Credenciales incorrectas");
      return;
    }

    snap.forEach(d => usuarioActual = d.data());

    login.style.display = "none";
    menu.style.display = "flex";
    mostrar("clientes");
  };
    /* ===================== FACTURAS ===================== */
    window.guardarFactura = async function () {
      const clienteId = document.getElementById("facturaCliente").value;
      const numeroFactura = document.getElementById("numeroFactura").value.trim();
      const monto = parseFloat(document.getElementById("montoFactura").value);
      const fecha = document.getElementById("fechaFactura").value;

      if (!clienteId || !numeroFactura || !monto || !fecha) {
        alert("Completa todos los campos de la factura");
        return;
      }

      // validar número de factura único
      const q = query(
        collection(db, "facturas"),
        where("numeroFactura", "==", numeroFactura)
      );
      const existe = await getDocs(q);
      if (!existe.empty) {
        alert("Ese número de factura ya existe");
        return;
      }

      const clienteDoc = await getDoc(doc(db, "clientes", clienteId));

      await addDoc(collection(db, "facturas"), {
        clienteId,
        nombreCliente: clienteDoc.data().nombre,
        numeroCliente: clienteDoc.data().numeroCliente,
        numeroFactura,
        monto,
        fechaFactura: fecha,
        usuario: usuarioActual.nombre,
        createdAt: new Date()
      });

      document.getElementById("numeroFactura").value = "";
      document.getElementById("montoFactura").value = "";

      alert("Factura registrada");
    };

    async function cargarClientesSelect() {
      const select = document.getElementById("facturaCliente");
      select.innerHTML = "<option value=''>Selecciona cliente</option>";

      const snap = await getDocs(collection(db, "clientes"));
      snap.forEach(d => {
        const c = d.data();
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = `${c.numeroCliente} - ${c.nombre}`;
        select.appendChild(opt);
      });
    }

    /* ===================== REPORTES ===================== */
    window.generarReporte = async function () {
      const tipo = document.getElementById("tipoReporte").value;
      const salida = document.getElementById("resultadoReporte");
      salida.innerHTML = "";

      let facturas = [];

      if (tipo === "cliente") {
        const clienteId = document.getElementById("reporteCliente").value;
        if (!clienteId) return alert("Selecciona un cliente");

        const q = query(
          collection(db, "facturas"),
          where("clienteId", "==", clienteId)
        );
        const snap = await getDocs(q);
        snap.forEach(d => facturas.push(d.data()));
      }

      if (tipo === "global") {
        const snap = await getDocs(collection(db, "facturas"));
        snap.forEach(d => facturas.push(d.data()));
      }

      if (facturas.length === 0) {
        salida.innerHTML = "<p>No hay datos</p>";
        return;
      }

      let total = 0;
      let html = `
        <table>
          <tr>
            <th>Factura</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Monto</th>
          </tr>
      `;

      facturas.forEach(f => {
        total += f.monto;
        html += `
          <tr>
            <td>${f.numeroFactura}</td>
            <td>${f.nombreCliente}</td>
            <td>${f.fechaFactura}</td>
            <td>$${f.monto.toFixed(2)}</td>
          </tr>
        `;
      });

      html += `
        <tr>
          <td colspan="3"><strong>Total</strong></td>
          <td style="color:green;"><strong>$${total.toFixed(2)}</strong></td>
        </tr>
        </table>
        <button onclick="imprimirPDF()">Generar PDF</button>
      `;

      salida.innerHTML = html;
    };

    window.imprimirPDF = function () {
      window.print();
    };

    /* ===================== USUARIOS (ADMIN) ===================== */
    window.guardarUsuario = async function () {
      if (usuarioActual.rol !== "admin") {
        alert("Solo el administrador puede gestionar usuarios");
        return;
      }

      const nombre = document.getElementById("nuevoNombre").value.trim();
      const pass = document.getElementById("nuevoPass").value.trim();
      const rol = document.getElementById("nuevoRol").value;

      if (!nombre || !pass) {
        alert("Completa los datos");
        return;
      }

      await addDoc(collection(db, "usuarios"), {
        nombre,
        password: pass,
        rol
      });

      alert("Usuario creado");
      document.getElementById("nuevoNombre").value = "";
      document.getElementById("nuevoPass").value = "";
      cargarUsuarios();
    };

    async function cargarUsuarios() {
      const lista = document.getElementById("listaUsuarios");
      if (!lista) return;

      lista.innerHTML = "";
      const snap = await getDocs(collection(db, "usuarios"));
      snap.forEach(d => {
        const u = d.data();
        lista.innerHTML += `<li>${u.nombre} (${u.rol})</li>`;
      });
    }

    /* ===================== INIT ===================== */
    document.addEventListener("DOMContentLoaded", async () => {
      if (usuarioActual) {
        cargarClientes();
        cargarClientesSelect();
        cargarUsuarios();
      }
    });
  </script>

</body>
</html>
